<?php
//$HORIZONTAL_ELEMENT_ID = array("1"=>_p("StatisticsRow1"), "2"=>_p("StatisticsRow2"), "3"=>_p("StatisticsRow3"));
//$HORIZONTAL_ELEMENT_NAME = array("1"=>"fire_year", "2"=>"aimag_code", "3"=>"soum_code");

$HORIZONTAL_ELEMENT_ID = array("2"=>_p("StatisticsRow2"), "3"=>_p("StatisticsRow3"));
$HORIZONTAL_ELEMENT_NAME = array("2"=>"aimag_code", "3"=>"soum_code");
$VERTICAL_ELEMENT_ID = array("1"=>_p("StatisticsSub3Column1"),
"2"=>_p("StatisticsSub3Column2"),"3"=>_p("StatisticsSub3Column3"),"4"=>_p("StatisticsSub3Column4"),"5"=>_p("StatisticsSub3Column5"),"6"=>_p("StatisticsSub3Column6"),
"7"=>_p("StatisticsSub3Column7"),"8"=>_p("StatisticsSub3Column8"),"9"=>_p("StatisticsSub3Column9"),"10"=>_p("StatisticsSub3Column10"),
"11"=>_p("StatisticsSub3Column11"),"12"=>_p("StatisticsSub3Column12"),"13"=>_p("StatisticsSub3Column13"),"14"=>_p("StatisticsSub3Column14"),"15"=>_p("StatisticsSub3Column15"),
"16"=>_p("StatisticsSub3Column16"),"17"=>_p("StatisticsSub3Column17"),"18"=>_p("StatisticsSub3Column18"),"19"=>_p("StatisticsSub3Column19"),"20"=>_p("StatisticsSub3Column20"),
"21"=>_p("StatisticsSub3Column21"),"22"=>_p("StatisticsSub3Column22"),"23"=>_p("StatisticsSub3Column23"),"24"=>_p("StatisticsSub3Column24"),"25"=>_p("StatisticsSub3Column25"),"26"=>_p("StatisticsSub3Column26"),
"27"=>_p("StatisticsSub3Column27"),"28"=>_p("StatisticsSub3Column28"),"29"=>_p("StatisticsSub3Column29"),
"30"=>_p("StatisticsSub3Column30"),"31"=>_p("StatisticsSub3Column31"),"32"=>_p("StatisticsSub3Column32"),"33"=>_p("StatisticsSub3Column33"),"34"=>_p("StatisticsSub3Column34"),"35"=>_p("StatisticsSub3Column35"),"36"=>_p("StatisticsSub3Column36"),
"37"=>_p("StatisticsSub3Column37"),"38"=>_p("StatisticsSub3Column38"),"39"=>_p("StatisticsSub3Column39"),
"40"=>_p("StatisticsSub3Column40"),"41"=>_p("StatisticsSub3Column41"),"42"=>_p("StatisticsSub3Column42"),"43"=>_p("StatisticsSub3Column43"),
"44"=>_p("StatisticsSub3Column44"),"45"=>_p("StatisticsSub3Column45"),
);
$VERTICAL_ELEMENT_NAME = array("1"=>"fire_number",
"2"=>"burnt_forest_area","3"=>"burnt_pasture_area","4"=>"burnt_argiculture_area","5"=>"burnt_grassland_area","6"=>"total_burnt_area",
"7"=>"burnt_larch_area","8"=>"burnt_pine_area","9"=>"burnt_evergreen_area","10"=>"burnt_othertree_area",
"11"=>"mobilized_people_number","12"=>"mobilized_car_number","13"=>"mobilized_tractor_number","14"=>"mobilized_motorcycle_number","15"=>"mobilized_cart_number",
"16"=>"forest_damage_cost","17"=>"pasture_damage_cost","18"=>"wildlife_damage_cost","19"=>"animal_damage_cost","20"=>"ger_damage_cost",
"21"=>"house_damage_cost","22"=>"fence_damage_cost","23"=>"car_damage_cost","24"=>"grass_damage_cost","25"=>"other_property_cost","26"=>"total_damage_cost",
"27"=>"died_people_number","28"=>"burnt_people_number","29"=>"affected_people_number",
"30"=>"damp_food_cost","31"=>"damp_petrol_cost","32"=>"damp_aeroplain_cost","33"=>"damp_salary_cost","34"=>"damp_moving_cost","35"=>"damp_other_cost","36"=>"total_damp_cost",
"37"=>"prevention_technics_cost","38"=>"prevention_canvass_cost","39"=>"prevention_firewarden_cost",
"40"=>"prevention_training_cost","41"=>"prevention_dustbelt_cost","42"=>"prevention_burntbelt_cost","43"=>"prevention_clearing_cost",
"44"=>"damage_indemnity_exhaustive","45"=>"damage_indemnity_put",
);
$VERTICAL_ELEMENT_UNIT = array("1"=>_p("StatisticsSub3Unit1"),
"2"=>_p("StatisticsSub3Unit2"),"3"=>_p("StatisticsSub3Unit2"),"4"=>_p("StatisticsSub3Unit2"),"5"=>_p("StatisticsSub3Unit2"),"6"=>_p("StatisticsSub3Unit2"),
"7"=>_p("StatisticsSub3Unit2"),"8"=>_p("StatisticsSub3Unit2"),"9"=>_p("StatisticsSub3Unit2"),"10"=>_p("StatisticsSub3Unit2"),
"11"=>_p("StatisticsSub3Unit1"),"12"=>_p("StatisticsSub3Unit1"),"13"=>_p("StatisticsSub3Unit1"),"14"=>_p("StatisticsSub3Unit1"),"15"=>_p("StatisticsSub3Unit1"),
"16"=>_p("StatisticsSub3Unit3"),"17"=>_p("StatisticsSub3Unit3"),"18"=>_p("StatisticsSub3Unit3"),"19"=>_p("StatisticsSub3Unit3"),"20"=>_p("StatisticsSub3Unit3"),
"21"=>_p("StatisticsSub3Unit3"),"22"=>_p("StatisticsSub3Unit3"),"23"=>_p("StatisticsSub3Unit3"),"24"=>_p("StatisticsSub3Unit3"),"25"=>_p("StatisticsSub3Unit3"),"26"=>_p("StatisticsSub3Unit3"),
"27"=>_p("StatisticsSub3Unit1"),"28"=>_p("StatisticsSub3Unit1"),"29"=>_p("StatisticsSub3Unit1"),
"30"=>_p("StatisticsSub3Unit3"),"31"=>_p("StatisticsSub3Unit3"),"32"=>_p("StatisticsSub3Unit3"),"33"=>_p("StatisticsSub3Unit3"),"34"=>_p("StatisticsSub3Unit3"),"35"=>_p("StatisticsSub3Unit3"),"36"=>_p("StatisticsSub3Unit3"),
"37"=>_p("StatisticsSub3Unit3"),"38"=>_p("StatisticsSub3Unit3"),"39"=>_p("StatisticsSub3Unit3"),
"40"=>_p("StatisticsSub3Unit3"),"41"=>_p("StatisticsSub3Unit3"),"42"=>_p("StatisticsSub3Unit3"),"43"=>_p("StatisticsSub3Unit3"),
"44"=>_p("StatisticsSub3Unit3"),"45"=>_p("StatisticsSub3Unit3"),
);

$selQuery = "SELECT MIN(taf.fire_year) minyear, MAX(taf.fire_year) maxyear FROM ".$schemas.".taforestfire taf";
$rowyear = $db->query($selQuery);	

if(!empty($rowyear) && $rowyear[0]["minyear"]>0) 
	$minyear = $rowyear[0]["minyear"];

if(!empty($rowyear) && $rowyear[0]["maxyear"]>0) 
	$today = $rowyear[0]["maxyear"];

$statistic_aimag_code =  0;
$statistic_horizontal_id = 2;
$statistic_vertical_id = 1;
$statistic_year = $today;
	
if (isset($_POST["searchforestfirebttn"])) 
{
	$statistic_aimag_code = (isset($_POST["statistic_aimag_code"])) ? (int) $_POST["statistic_aimag_code"] : 0;
	
	$statistic_horizontal_id = (isset($_POST["statistic_horizontal_id"])) ? (int) $_POST["statistic_horizontal_id"] : 2;
	
	$statistic_vertical_id = (isset($_POST["statistic_vertical_id"])) ? (int) $_POST["statistic_vertical_id"] : 1;

	$statistic_year = (isset($_POST["statistic_year"]) && (int) $_POST["statistic_year"]>0) ? (int) $_POST["statistic_year"] : $today;
	
	if($statistic_year < $minyear)
		$statistic_year = $minyear;
}
	
require("statistics/taforestfire/inc.search_forestfire.php");	

$searchQuery = "";

if ($statistic_aimag_code == 0) 
{
	$searchQuery .= "";
} else 
{
	$searchQuery .= " AND va.aimag_code = ".$statistic_aimag_code;
}
	
if ($statistic_year == 0) 
{
	$searchQuery .= "";
}else
{
	$searchQuery .= " AND taf.fire_year = ".$statistic_year;
}

$statistic_horizontal_name = $HORIZONTAL_ELEMENT_NAME[$statistic_horizontal_id];
$statistic_vertical_name = $VERTICAL_ELEMENT_NAME[$statistic_vertical_id];

$startQuery = "SELECT";
$valueQuery = "sum(taf.".$statistic_vertical_name.") as sum_total";
$fromQuery = "FROM ".$schemas.".taforestfire taf, scadministrative.vasoumname va";
$whereQuery = "WHERE taf.soum_code = va.soum_code";
$groupQuery = "GROUP BY";
$sortQuery = "ORDER BY";

if($statistic_horizontal_id==1){
	$valueQuery .= ", taf.fire_year";
	$groupQuery .= " taf.fire_year";
	$sortQuery .= " taf.fire_year DESC";
}else if($statistic_horizontal_id==2){
	$valueQuery .= ", va.aimag_name_mn, va.aimag_name_en";
	$groupQuery .= " va.aimag_name_mn, va.aimag_name_en";
	$sortQuery .= " va.aimag_name_mn, va.aimag_name_en";
}else if($statistic_horizontal_id==3){
	$valueQuery .= ", va.soum_name_mn, va.soum_name_en";
	$groupQuery .= " va.soum_name_mn, va.soum_name_en";
	$sortQuery .= " va.soum_name_mn, va.soum_name_en";	
}

$selQuery = $startQuery." ".$valueQuery." ".$fromQuery." ".$whereQuery." ".$searchQuery." ".$groupQuery." ".$sortQuery;
//echo $selQuery;
$rows = $db->query($selQuery);

$count = 10;

if(!empty($rows)) 
{
	//print_r($rows);
	$count = sizeof($rows)+1;
?>
<nav>
  <div class="nav nav-tabs" id="nav-tab" role="tablist">
    <a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-sub1" role="tab" aria-controls="nav-sub1" aria-selected="true"><?php echo _p("StatisticsBrowseText1"); ?></a>
    <a class="nav-item nav-link" id="nav-sub2-tab" data-toggle="tab" href="#nav-sub2" role="tab" aria-controls="nav-sub2" aria-selected="false"><?php echo _p("StatisticsBrowseText2"); ?></a>
  </div>
</nav>
<div class="tab-content" id="nav-tabContent">
  <div class="tab-pane fade show active" id="nav-sub1" role="tabpanel" aria-labelledby="nav-sub1-tab">
    <br>
	<div class="table-responsive">
	  <table id="forestresource_datatables" class="table table-bordered table-hover" title_name="<?php echo _p("ResourceSubTitle3"); ?>" file_name="statisticsdata" column_name="0, 1, 2" language_name="<?php echo $language_name;?>" page_count="<?php echo $count;?>">
		<thead>
		  <tr>
			<th><?php echo _p("Number");?></th>
			<th><?php echo _p($HORIZONTAL_ELEMENT_ID[$statistic_horizontal_id]); ?></th>
			<th><?php echo _p($VERTICAL_ELEMENT_ID[$statistic_vertical_id]); ?></th>
		  </tr>
		</thead>
		<tbody>
		  <?php	
		    $sum_total = 0;
		    $check_negative =0;
			
			for ($i = 0; $i < sizeof($rows); $i++) 
			{
				$sum_total = $sum_total + $rows[$i]["sum_total"];
				if($rows[$i]["sum_total"]<=0) $check_negative++;
			?>
		  <tr>
			<td><?php echo $i + 1; ?></td>
			<td><?php 
					if($statistic_horizontal_id==1){
						echo $rows[$i]["fire_year"]; 
					}else if($statistic_horizontal_id==2){
						echo $rows[$i]["aimag_name_$language_name"]; 
					}else if($statistic_horizontal_id==3){
						echo $rows[$i]["soum_name_$language_name"]; 
					}
				?></td>
			<td><?php echo $rows[$i]["sum_total"]; ?></td>
		  </tr>
		  <?php
			}
			?>
		  <tr>
			<th>-</th>
			<th><?php echo _p("StatisticsBrowseText3"); ?></th>
			<th><?php echo $sum_total; ?></th>
		  </tr>					
		</tbody>
	  </table>
	</div>
  </div>
  <div class="tab-pane fade" id="nav-sub2" role="tabpanel" aria-labelledby="nav-sub2-tab">
	<br>
	<div class="pull-left">
		<button type="button" class="chart_option1 btn btn-success" id="column"><i class="fa fa-bar-chart"></i> </button>
		<button type="button" class="chart_option1 btn btn-success" id="line"><i class="fa fa-line-chart"></i> </button>
		<button type="button" class="chart_option1 btn btn-success" id="bar"><i class="fa fa-align-left"></i> </button>
		<button type="button" class="chart_option1 btn btn-success" id="area"><i class="fa fa-area-chart"></i> </button>
		<?php if($check_negative==0) { ?>
		<button type="button" class="chart_option1 btn btn-success" id="pie"><i class="fa fa-pie-chart"></i> </button>
		<?php } ?>
	</div>
	<div id="highchart-container1"></div>
  </div>
</div>
<script>
$(function() {
	var datacategories = [
		<?php for ($i=0; $i < sizeof($rows); $i++){ 	
			if($statistic_horizontal_id==1){
				echo "'".$rows[$i]["fire_year"]."', ";
			} else if($statistic_horizontal_id==2){
				echo "'".$rows[$i]["aimag_name_$language_name"]."', "; 
			} else if($statistic_horizontal_id==3){
				echo "'".$rows[$i]["soum_name_$language_name"]."', ";
			}
		
		} ?>
	];
	var dataseries = [{
		name: '<?php echo $VERTICAL_ELEMENT_ID[$statistic_vertical_id]; ?>',		
		data: [			
		<?php for ($i=0; $i < sizeof($rows); $i++) { 
			if($statistic_horizontal_id==1){
				echo "[ '".$rows[$i]["fire_year"]."', ";
			} else if($statistic_horizontal_id==2){
				echo "[ '".$rows[$i]["aimag_name_$language_name"]."', "; 
			} else if($statistic_horizontal_id==3){
				echo "[ '".$rows[$i]["soum_name_$language_name"]."', ";
			}
			if(!empty($rows[$i]["sum_total"])) echo round($rows[$i]["sum_total"],2)." ], "; else echo "0 ], "; } ?>
		], 
		color: Highcharts.getOptions().colors[4]
	}];

		//create a variable so we can pass the value dynamically
	var chartype = 'column';
 
	//On page load call the function setDynamicChart
	setDynamicChart(chartype);
 
	//jQuery part - On Click call the function setDynamicChart(dynval) and pass the chart type
	$('.chart_option1').click(function(){
		//get the value from 'a' tag
		var chartype = $(this).attr('id');
		setDynamicChart(chartype);
	});
 
	//function is created so we pass the value dynamically and be able to refresh the HighCharts on every click
 
	function setDynamicChart(chartype){
		$('#highchart-container1').highcharts({
			chart: {
				type: chartype,
			},
			credits: {
				enabled: false,
			},
			title: {
				text: '<?php echo $VERTICAL_ELEMENT_ID[$statistic_vertical_id]; ?>',
			},
			xAxis: {
				categories: datacategories,
			},
			yAxis: {				
				title: {
					text: '<?php echo $VERTICAL_ELEMENT_UNIT[$statistic_vertical_id]; ?>',
				}
			},	
			tooltip: {
				shared: true,
				useHTML: true,
				crosshairs: [true,true],
			},
			plotOptions: {
				line: {
					dataLabels: {
						enabled: true,
					}, 
					tooltip: {
						headerFormat: '{point.key} <br>',
						pointFormat: '{series.name}: <strong>{point.y}</strong> <br>',
					},					
				}, 
				area: {
					dataLabels: {
						enabled: true,
					},
					fillOpacity: 0.5, 
					tooltip: {
						headerFormat: '{point.key} <br>',
						pointFormat: '{series.name}: <strong>{point.y}</strong> <br>',
					},	
				}, 
				column: {
					dataLabels: {
						enabled: true,
					},
					pointPadding: 0.2,
					borderWidth: 0,
					groupPadding: 0,
					shadow: false,
					tooltip: {
						headerFormat: '{point.key} <br>',
						pointFormat: '{series.name}: <strong>{point.y}</strong> <br>',
					},					
				},
				bar: {
					dataLabels: {
						enabled: true,
					},
					pointPadding: 0.2,
					borderWidth: 0,
					groupPadding: 0,
					shadow: false,
					tooltip: {
						headerFormat: '{point.key} <br>',
						pointFormat: '{series.name}: <strong>{point.y}</strong> <br>',
					},					
				},
				pie: {
					size:'100%',
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: true,
						format: '<strong>{point.name}</strong>: {point.percentage:.1f} %',
					},
					showInLegend: true,
					tooltip: {
						pointFormat: '{point.y} <?php echo $VERTICAL_ELEMENT_UNIT[$statistic_vertical_id]; ?>, {point.percentage:.1f}%'
					},	
				}
			},
			series: dataseries,
			
		});
	}   
});

</script>
<?php
	} else {
		show_notification("error", _p("NotRowText"), "");	
	}
?>

